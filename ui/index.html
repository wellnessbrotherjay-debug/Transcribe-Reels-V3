<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Reel Transcribe | Vercel</title>
  <style>
    :root {
      --bg: #0a1226;
      --card: #111d3a;
      --line: #223665;
      --primary: #4ea3ff;
      --primary-2: #7bc6ff;
      --text: #ecf2ff;
      --muted: #9eb0d8;
      --ok: #3ddc97;
      --error: #ff6f6f;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      color: var(--text);
      background:
        radial-gradient(900px 500px at -10% -20%, rgba(78, 163, 255, 0.35), transparent),
        radial-gradient(1000px 600px at 110% 0%, rgba(123, 198, 255, 0.2), transparent),
        var(--bg);
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      min-height: 100vh;
    }

    .wrap {
      max-width: 980px;
      margin: 0 auto;
      padding: 36px 16px 64px;
    }

    .panel {
      background: linear-gradient(180deg, rgba(17,29,58,0.96), rgba(11,21,45,0.95));
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 18px;
      box-shadow: 0 14px 30px rgba(0, 0, 0, 0.35);
    }

    h1 {
      margin: 0 0 8px;
      font-size: 28px;
    }

    .sub {
      margin: 0 0 18px;
      color: var(--muted);
      line-height: 1.5;
    }

    .row {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 10px;
      margin-bottom: 12px;
    }

    input[type="url"] {
      width: 100%;
      padding: 12px;
      border-radius: 10px;
      border: 1px solid #35508f;
      background: #0c1835;
      color: var(--text);
      outline: none;
    }

    input[type="url"]:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(78, 163, 255, 0.2);
    }

    button {
      border: none;
      border-radius: 10px;
      padding: 12px 14px;
      background: linear-gradient(135deg, var(--primary), var(--primary-2));
      color: #041129;
      font-weight: 700;
      cursor: pointer;
    }

    button[disabled] {
      opacity: 0.55;
      cursor: not-allowed;
    }

    .meta {
      margin-top: 8px;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.5;
    }

    .status {
      margin-top: 16px;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid #2f487f;
      background: #0c1731;
      font-size: 14px;
      color: var(--muted);
    }

    .status.ok {
      border-color: rgba(61, 220, 151, 0.5);
      color: var(--ok);
    }

    .status.error {
      border-color: rgba(255, 111, 111, 0.45);
      color: var(--error);
    }

    .output {
      margin-top: 16px;
      display: grid;
      grid-template-columns: 1fr;
      gap: 14px;
    }

    textarea {
      width: 100%;
      min-height: 220px;
      resize: vertical;
      padding: 12px;
      border-radius: 10px;
      border: 1px solid #35508f;
      background: #0b1630;
      color: var(--text);
      line-height: 1.5;
    }

    .footer {
      margin-top: 14px;
      font-size: 12px;
      color: var(--muted);
    }

    @media (max-width: 740px) {
      .row {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <main class="wrap">
    <section class="panel">
      <h1>Reel Transcribe (Vercel Mode)</h1>
      <p class="sub">
        Paste a public audio/video URL, generate transcript with AssemblyAI, then summarize with OpenAI.
        This mode avoids local Docker/FFmpeg hosting.
      </p>

      <div class="row">
        <input id="mediaUrl" type="url" placeholder="https://...mp3 or ...mp4" />
        <button id="startBtn">Transcribe</button>
      </div>

      <div class="meta">
        For many Instagram links, direct media access can fail due auth/rate limits.
        If that happens, use an accessible media URL or your Ubuntu server flow.
      </div>

      <div id="status" class="status">Idle</div>

      <div class="output">
        <textarea id="transcript" placeholder="Transcript will appear here..."></textarea>
        <button id="summaryBtn" disabled>Generate Summary</button>
        <textarea id="summary" placeholder="Summary will appear here..."></textarea>
      </div>

      <div class="footer">API routes: /api/transcribe_start, /api/transcribe_status, /api/summarize</div>
    </section>
  </main>

  <script>
    const mediaUrlInput = document.getElementById('mediaUrl');
    const startBtn = document.getElementById('startBtn');
    const statusEl = document.getElementById('status');
    const transcriptEl = document.getElementById('transcript');
    const summaryBtn = document.getElementById('summaryBtn');
    const summaryEl = document.getElementById('summary');

    function setStatus(message, type) {
      statusEl.textContent = message;
      statusEl.className = 'status' + (type ? ` ${type}` : '');
    }

    async function wait(ms) {
      return new Promise((resolve) => setTimeout(resolve, ms));
    }

    async function pollTranscript(id) {
      const maxAttempts = 50;
      let attempt = 0;

      while (attempt < maxAttempts) {
        attempt += 1;
        setStatus(`Processing transcript... (${attempt}/${maxAttempts})`, '');

        const res = await fetch(`/api/transcribe_status?id=${encodeURIComponent(id)}`);
        const data = await res.json();

        if (!res.ok) {
          throw new Error(data.error || 'Status polling failed.');
        }

        if (data.status === 'completed') {
          return data.text || '';
        }

        if (data.status === 'error') {
          throw new Error(data.error || 'AssemblyAI returned an error status.');
        }

        await wait(3000);
      }

      throw new Error('Timed out waiting for transcript completion.');
    }

    startBtn.addEventListener('click', async () => {
      const mediaUrl = mediaUrlInput.value.trim();
      if (!mediaUrl) {
        setStatus('Enter a media URL first.', 'error');
        return;
      }

      startBtn.disabled = true;
      summaryBtn.disabled = true;
      transcriptEl.value = '';
      summaryEl.value = '';

      try {
        setStatus('Creating transcript job...', '');
        const createRes = await fetch('/api/transcribe_start', {
          method: 'POST',
          headers: { 'content-type': 'application/json' },
          body: JSON.stringify({ mediaUrl }),
        });

        const createData = await createRes.json();
        if (!createRes.ok) {
          throw new Error(createData.error || 'Failed to create transcript job.');
        }

        const text = await pollTranscript(createData.id);
        transcriptEl.value = text;
        summaryBtn.disabled = text.trim().length < 20;
        setStatus('Transcript complete.', 'ok');
      } catch (error) {
        setStatus(error.message || String(error), 'error');
      } finally {
        startBtn.disabled = false;
      }
    });

    summaryBtn.addEventListener('click', async () => {
      const text = transcriptEl.value.trim();
      if (text.length < 20) {
        setStatus('Transcript is too short for summary.', 'error');
        return;
      }

      summaryBtn.disabled = true;
      try {
        setStatus('Generating summary...', '');
        const res = await fetch('/api/summarize', {
          method: 'POST',
          headers: { 'content-type': 'application/json' },
          body: JSON.stringify({ text }),
        });

        const data = await res.json();
        if (!res.ok) {
          throw new Error(data.error || 'Summary generation failed.');
        }

        summaryEl.value = data.summary || '';
        setStatus('Summary complete.', 'ok');
      } catch (error) {
        setStatus(error.message || String(error), 'error');
      } finally {
        summaryBtn.disabled = false;
      }
    });
  </script>
</body>
</html>
